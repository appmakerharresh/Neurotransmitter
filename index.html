<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini WhatsApp WebRTC</title>
<style>
  body,html { margin:0; padding:0; font-family: Arial,sans-serif; height:100vh; display:flex; flex-direction:column; }
  #loginScreen, #chatScreen { flex:1; display:none; flex-direction: column; }
  #loginScreen.active, #chatScreen.active { display:flex; }
  #loginScreen { justify-content:center; align-items:center; }
  #loginBox { border:1px solid #ccc; padding:20px; border-radius:8px; width: 280px; text-align:center; }
  #loginBox input { width: 100%; padding:8px; margin:8px 0; font-size: 16px; }
  #loginBox button { width: 100%; padding:8px; background:#25d366; border:none; color:white; font-weight: bold; cursor:pointer; border-radius: 4px; }
  #loginBox button:hover { background:#1ebe57; }
  
  #chatScreen { flex:1; }
  #header { background:#075e54; color:#fff; padding: 12px 16px; font-weight: bold; display:flex; justify-content:space-between; align-items:center; }
  #header #peerLabel { font-size: 14px; }
  #chatArea { flex:1; overflow-y:auto; padding:10px; background:#ece5dd; display:flex; flex-direction: column; }
  .message { margin:5px 0; max-width: 70%; padding:8px 12px; border-radius: 10px; word-break: break-word; }
  .message.sent { background:#dcf8c6; align-self:flex-end; }
  .message.received { background:#fff; align-self:flex-start; }
  #inputArea { display:flex; padding: 10px; background:#f0f0f0; }
  #inputArea input { flex:1; padding:10px; font-size:16px; border-radius:20px; border:1px solid #ccc; outline:none; }
  #inputArea button { margin-left:8px; padding:0 20px; font-weight:bold; background:#25d366; border:none; border-radius:20px; color:#fff; cursor:pointer; }
  #inputArea button:disabled { background:#9ed49e; cursor:not-allowed; }
  #exploreBtn { margin-left: 16px; background:#128c7e; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; color:#fff; font-size: 14px; }
  #exploreBtn:hover { background:#075e54; }
</style>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>

<!-- Login screen -->
<div id="loginScreen" class="active">
  <div id="loginBox">
    <h2>Login</h2>
    <input id="usernameInput" placeholder="Your username" />
    <input id="peerUsernameInput" placeholder="Peer username" />
    <button id="loginBtn">Start Chat</button>
  </div>
</div>

<!-- Chat screen -->
<div id="chatScreen">
  <div id="header">
    <div>Chat with: <span id="peerLabel"></span></div>
    <button id="exploreBtn">Explore My Websites</button>
  </div>
  <div id="chatArea"></div>
  <div id="inputArea">
    <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
    <button id="sendBtn" disabled>Send</button>
  </div>
</div>

<script>
  let peer;
  let conn;
  let username = '';
  let peerUsername = '';

  const loginScreen = document.getElementById('loginScreen');
  const chatScreen = document.getElementById('chatScreen');
  const usernameInput = document.getElementById('usernameInput');
  const peerUsernameInput = document.getElementById('peerUsernameInput');
  const loginBtn = document.getElementById('loginBtn');
  const peerLabel = document.getElementById('peerLabel');
  const chatArea = document.getElementById('chatArea');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const exploreBtn = document.getElementById('exploreBtn');

  function addMessage(text, sent) {
    const div = document.createElement('div');
    div.className = 'message ' + (sent ? 'sent' : 'received');
    div.textContent = text;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  loginBtn.onclick = () => {
    username = usernameInput.value.trim();
    peerUsername = peerUsernameInput.value.trim();
    if (!username) {
      alert('Enter your username');
      return;
    }
    if (!peerUsername) {
      alert('Enter peer username');
      return;
    }

    peer = new Peer(username, {
      debug: 2,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'turn:numb.viagenie.ca', credential: 'muazkh', username: 'webrtc@live.com' }
        ]
      }
    });

    peer.on('open', () => {
      loginScreen.classList.remove('active');
      chatScreen.classList.add('active');
      peerLabel.textContent = peerUsername;
      sendBtn.disabled = false;
    });

    peer.on('connection', c => {
      if (conn && conn.open) {
        c.close(); // only allow one connection
        return;
      }
      conn = c;
      setupConnection();
    });

    // connect to peer after peer opens
    peer.on('open', () => {
      if (!conn) {
        conn = peer.connect(peerUsername);
        setupConnection();
      }
    });
  };

  function setupConnection() {
    conn.on('open', () => {
      addMessage(`Connected to ${peerUsername}`, false);
    });

    conn.on('data', data => {
      addMessage(data, false);
    });

    conn.on('close', () => {
      addMessage('Connection closed', false);
      conn = null;
      sendBtn.disabled = true;
    });

    conn.on('error', err => {
      console.error(err);
      alert('Connection error: ' + err);
    });
  }

  sendBtn.onclick = () => {
    let msg = messageInput.value.trim();
    if (!msg) return;
    if (!conn || !conn.open) {
      alert('Not connected to peer');
      return;
    }
    conn.send(msg);
    addMessage(msg, true);
    messageInput.value = '';
  };

  messageInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendBtn.click();
  });

  exploreBtn.onclick = () => {
    window.open('https://appmakervishal.github.io/showcase/', '_blank');
  };
</script>

</body>
</html>
